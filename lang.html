---
layout: default
---

<h1>
<a name="the-salve-language" class="anchor" href="#the-salve-language"><span class="octicon octicon-link"></span></a>The SALVE Language</h1>

<p>What does a SALVE manifest actually look like?
Here we describe the basic format of a manifest file.</p>

<h2>
<a name="example-manifest" class="anchor" href="#example-manifest"><span class="octicon octicon-link"></span></a>Example Manifest</h2>

<p>We begin with an example, which will be broken down and explained in the sections below.</p>

<pre><code>file {
    source  files/bash/bashrc
    target  $HOME/.bashrc
    mode    600
}

directory {
    source  dirs/dircolors
    target  $HOME/dircolors
    action  copy
}

file {
    source  /etc/passwd
    target  /opt/myprog/passwd-clone
    mode    0440
    user    admin
    group   root
}

manifest {
    source  manifests/vim.manifest
}
</code></pre>

<h2>
<a name="the-grammar" class="anchor" href="#the-grammar"><span class="octicon octicon-link"></span></a>The Grammar</h2>

<p>A manifest is a file containing expressions, <em>e,</em> in the following basic grammar.
Some liberties have been taken with notation below.</p>

<pre><code>e := Empty String
   | block_id { attrs } e

block_id := "file"
          | "directory"
          | "manifest"

attrs := Empty String
       | name value attrs

name := namechar name
      | namechar

namechar := alpha
          | digit
          | "_"

value := valuechar value
       | valuechar
       | '"' quotedvalue '"'
       | "'" quotedvalue "'"

quotedvalue := quotedchar quotedvalue
             | quotedchar

quotedchar := valuechar | " "

valuechar := namechar
           | "_" | "-" | "+"
           | "=" | "^" | "&amp;"
           | "@" | "`" | "/"
           | "|" | "~" | "$"
           | "(" | ")" | "["
           | "]" | "." | ","
           | "&lt;" | "&gt;" | "*"
           | "?" | "!" | "%"
           | "#"
</code></pre>

<p>Note that this only defines the grammar of acceptable SALVE expressions
for the parser.
There are further constraints upon what keywords are valid and carry
meaning.
Those are defined below.</p>

<h2>
<a name="variables" class="anchor" href="#variables"><span class="octicon octicon-link"></span></a>Variables</h2>

<p>SALVE supports the use of environment variables in templates.
These values will be pulled out of the executing shell's environment, and used to expand the attribute values of blocks in manifests.</p>

<p>There are a small number of exceptions to this.</p>

<p><code>SUDO_USER</code> is inspected, and if set, used in place of <code>USER</code>.
At present, there is no way to specify the real value of <code>USER</code>, regardless of 'sudo' invocation, but this is in progress.</p>

<p><code>SALVE_ROOT</code> always refers to the root directory of the SALVE repo.</p>

<p><code>SALVE_USER_PRIMARY_GROUP</code> always refers to the primary group of <code>USER</code>, after <code>SUDO_USER</code> substitution.</p>

<p><code>HOME</code> always refers to the home directory of <code>USER</code> after <code>SUDO_USER</code> substitution.
This ensures that <code>HOME</code> always refers to the invoking user's homedir, even if sudo is set to reset the <code>HOME</code> environment variable.</p>

<h3>
<a name="example" class="anchor" href="#example"><span class="octicon octicon-link"></span></a>Example</h3>

<p>Given the block below</p>

<pre><code>file {
    source  files/bash/bashrc
    target  $HOME/.bashrc
    mode    600
}
</code></pre>

<p>When SALVE is invoked by a user, "user1", with home directory "/home/user1",
the value of "target" after expansion is "/home/user1/.bashrc"
This holds even when "user1" invokes SALVE with sudo.</p>

<h2>
<a name="relative-paths" class="anchor" href="#relative-paths"><span class="octicon octicon-link"></span></a>Relative Paths</h2>

<p>Relative paths are also supported, so that it is not necessary to rely on values like <code>$SALVE_ROOT</code> and <code>$PWD</code>.
Relative paths are always interpreted relative to the root manifest's location.
One item on the docket is to make this an available override behavior via the fileroot commandline option, but to specify relative paths with respect to the dirname of the manifest that contains the block in question.</p>

<h3>
<a name="example-1" class="anchor" href="#example-1"><span class="octicon octicon-link"></span></a>Example</h3>

<p>Given the block below</p>

<pre><code>file {
    source  files/bash/bashrc
    target  $HOME/.bashrc
    mode    600
}
</code></pre>

<p>if SALVE is invoked as <code>python salve.py -m /tmp/myconf/root.manifest</code>,
then the value of "source" after expansion is "/tmp/myconf/files/bash/bashrc"</p>

<h2>
<a name="definitions" class="anchor" href="#definitions"><span class="octicon octicon-link"></span></a>Definitions</h2>

<p>Each attribute of a block has a specific meaning, and many of the values themselves are keywords referring to specific actions.
Knowing these meanings is key to reading and understanding a manifest.
Below are the definitions of each manifest action, given in a subscript notation.
For example, <code>file[action]</code> specifies the 'action' attribute of 'file' blocks.</p>

<h3>
<a name="fileaction" class="anchor" href="#fileaction"><span class="octicon octicon-link"></span></a>file[action]</h3>
<p>Specifies what the file block does.</p>

<ul>
<li><p><code>file[action]=copy</code><br />
The copy action copies <code>file[source]</code> to <code>file[target]</code></p></li>

<li><p><code>file[action]=create</code><br />
The create action touches <code>file[target]</code></p></li>
</ul>

<h3>
<a name="filemode" class="anchor" href="#filemode"><span class="octicon octicon-link"></span></a>file[mode]</h3>
<p>Is the umask (given in the typical octal notation) to be set on the file specified by <code>file[target]</code>.</p>

<h3>
<a name="fileuser-filegroup" class="anchor" href="#fileuser-filegroup"><span class="octicon octicon-link"></span></a>file[user], file[group]</h3>
<p>These are set via chmod whenever SALVE is invoked as root.
Otherwise, they do nothing.</p>

<ul>
<li><p><code>file[user]</code><br />
The owner of <code>file[target]</code>.</p></li>

<li><p><code>file[group]</code><br />
The owning group of <code>file[target]</code>.</p></li>
</ul>

<h3>
<a name="filesource-filetarget" class="anchor" href="#filesource-filetarget"><span class="octicon octicon-link"></span></a>file[source], file[target]</h3>
<p>The paths to files specified by the block.
Typically the target is a location on the filesystem being configured, and the source is a file versioned in the SALVE repository being used to modify the target.</p>

<h3>
<a name="filebackup_dir-filebackup_log" class="anchor" href="#filebackup_dir-filebackup_log"><span class="octicon octicon-link"></span></a>file[backup_dir], file[backup_log]</h3>
<p>The backup_dir holds backups of any files that have destructive operations performed on them by the block.
The backup_log records all backups that are performed.</p>

<ul>
<li><p><code>file[backup_dir]</code><br />
The path to the directory in which file backups are stored</p></li>

<li><p><code>file[backup_log]</code><br />
The path to the file to which backup actions are logged (date, hash, full path to file)</p></li>
</ul>

<h3>
<a name="manifestsource" class="anchor" href="#manifestsource"><span class="octicon octicon-link"></span></a>manifest[source]</h3>
<p>The path to the manifest that is expanded at this location.</p>

<h3>
<a name="directoryaction" class="anchor" href="#directoryaction"><span class="octicon octicon-link"></span></a>directory[action]</h3>

<ul>
<li><p><code>directory[action]=create</code><br />
Create the directory at <code>directory[target]</code>, and any required ancestors</p></li>
<li><p><code>directory[action]=copy</code><br />
Create the directory at <code>directory[target]</code>, and then recursively copy contents from <code>directory[source]</code> to <code>directory[target]</code></p></li>
</ul>

<h3>
<a name="directorymode" class="anchor" href="#directorymode"><span class="octicon octicon-link"></span></a>directory[mode]</h3>
<p>Is the umask (given in the typical octal notation) to be set on the directory specified by <code>directory[target]</code>.</p>

<h3>
<a name="directoryuser-directorygroup" class="anchor" href="#directoryuser-directorygroup"><span class="octicon octicon-link"></span></a>directory[user], directory[group]</h3>
<p>These are set via chmod whenever SALVE is invoked as root.
Otherwise, they do nothing.</p>

<ul>
<li><p><code>directory[user]</code><br />
The owner of <code>directory[target]</code>.</p></li>

<li><p><code>file[group]</code><br />
The owning group of <code>directory[target]</code>.</p></li>
</ul>

<h3>
<a name="directorysource-directorytarget" class="anchor" href="#directorysource-directorytarget"><span class="octicon octicon-link"></span></a>directory[source], directory[target]</h3>
<p>The paths to directories specified by the block.
Typically the target is a location on the filesystem being configured, and the source is a directory versioned in the SALVE repository being used to modify the target.
When only one path exists, it is typically the target.</p>

<h3>
<a name="directorybackup_dir-directorybackup_log" class="anchor" href="#directorybackup_dir-directorybackup_log"><span class="octicon octicon-link"></span></a>directory[backup_dir], directory[backup_log]</h3>
<p>The backup_dir holds backups of any files that have destructive operations performed on them by the block.
The backup_log records all backups that are performed.</p>

<ul>
<li><p><code>file[backup_dir]</code><br />
The path to the directory in which file backups are stored</p></li>

<li><p><code>file[backup_log]</code><br />
The path to the file to which backup actions are logged (date, hash, full path to file)</p></li>
</ul>

<h2><a name="global-attributes" class="anchor" href="#global-attributes"><span class="octicon octicon-link"></span></a>Global Attributes</h2>

<p>Global attributes are attributes shared by all blocks.
They are specified in the default settings, and apply to all blocks uniformly.</p>


<h2><a name="sensible-defaults" class="anchor" href="#sensible-defaults"><span class="octicon octicon-link"></span></a>Sensible Defaults</h2>

<p>As much as possible, SALVE attempts to define all behavior on underspecified blocks.
These are our set of "sensible defaults", and they are specified in ini files.</p>

<p>A small class of attributes, when unspecified, result in errors.
Generally these are variables that refer to paths.
By specifying default values, SALVE replaces failure conditions with default behaviors that are understandable and even reliable.</p>

<h3><a name="defaults-ini" class="anchor" href="#defaults-ini"><span class="octicon octicon-link"></span></a>Defaults ini Format</h3>

<p>The ini file is applied to blocks based on simple matching rules.
Consider this ini file, which is the default for SALVE.</p>

<pre><code>[global]
backup_dir=$HOME/.salve/backups
backup_log=$HOME/.salve/backup.log

[file]
mode=600
user=$USER
group=$SALVE_USER_PRIMARY_GROUP
action=copy

[directory]
mode=755
user=$USER
group=$SALVE_USER_PRIMARY_GROUP
action=copy

[manifest]
</code></pre>

<p>This specifies that the global attributes <code>backup_dir</code> and <code>backup_log</code> should be applied to all blocks with the values <code>$HOME/.salve/backups</code> and <code>$HOME/.salve/backup.log</code> respectively.
Similarly, all file blocks should have a <code>mode</code> of <code>600</code>, and so forth.</p>


<h2><a name="attribute-precedence" class="anchor" href="#attribute-precedence"><span class="octicon octicon-link"></span></a>Attribute Precedence</h2>

<p>There are numerous locations at which the attribute value of a block can be specified.
Here we lay out the precedence order for attributes.
This should be mostly intuitive, as the most tightly scoped value is always taken.</p>

<p>A value specified in a block takes precedence over anything other than a global.
If a block has an attribute assigned in its declaration, that value is used no matter what the surrounding configuration state is.
Remember that this does not always guarantee the same behavior.
For example, multiple invocations the same file block that uses relative paths may have different base paths, and therefore different meanings.</p>

<p>Any ini file attributes specific to a block type take precedence over global attributes.
That is, given the ini file below,</p>

<pre><code>[global]
a=1
[file]
a=2
</code></pre>

<p>All file blocks will have <code>a</code> set to <code>2</code> unless locally overridden.
Only non-file blocks will see the global attribute value of <code>1</code>.</p>

<p>The precedence of ini files is Command Line Specified, then <code>$HOME/.salverc</code>, and finally <code>$SALVE_ROOT/default_settings.ini</code>.
If an ini file is given in the commandline, it takes precedence over all other files, and so forth.
The <code>salverc</code> is therefore a good way of applying overrides that apply to a specific system.
For example, I might maintain a default_settings.ini that looks something like this:</p>

<pre><code>[file]
user=sirosen
group=sirosen
</code></pre>

<p>If there is a machine on which I am not the administrator, and my primary group on that machine is <code>developers</code>, then I might want to add a salverc with the following content:</p>

<pre><code>[file]
group=developers
</code></pre>

<p>All of my other attribute specifications in the default settings file are still used, but I have overridden the <code>file[group]</code> on the machine.
In this way, overrides allow me to preserve my settings while maintaining system-specific configuration.</p>
